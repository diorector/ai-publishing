# SPEC-PUB-ORCHESTRATE-007: 청킹 ↔ 통합 ↔ 품질검수 오케스트레이션

**Version**: 1.0.0
**Status**: DRAFT
**Priority**: CRITICAL
**Phase**: Phase 1 (인프라 기반)
**Created**: 2025-11-16
**Updated**: 2025-11-16
**Language**: 한국어
**Owner**: @user

---

## 📋 규격 요약

모든 SPEC(001-006)의 기저를 이루는 공유 인프라입니다. 책 한 권 분량의 원고를 처리하기 위해 청크 단위로 분할하고, 여러 에이전트가 병렬로 처리한 청크들을 품질 검수하면서 통합하고, 최종적으로 일관된 완성원고를 생성하는 복잡한 오케스트레이션을 담당합니다.

**핵심 책임**:
1. 입력 원고의 현명한 청킹 (문맥 겹침, 메타데이터 관리)
2. 병렬 처리 작업 조율 (리소스 효율, 의존성 관리)
3. 단계별 품질 검수 (각 청크 품질 확인, 통일성 점검)
4. 청크 통합 및 일관성 보증 (재결합, 메타데이터 추적)
5. 최종 마크다운 생성 및 검증

---

## 🎯 필수 요구사항 (UBIQUITOUS)

> 시스템은 원본 구조 정보를 완벽히 추적해야 함 (청크ID, 원본위치, 메타데이터)
> 시스템은 병렬 처리 중 의존성을 관리해야 함
> 시스템은 청킹으로 인한 문맥 손실을 최소화해야 함 (겹침 처리)
> 시스템은 각 청크의 품질을 개별적으로 검증해야 함
> 시스템은 통합 후 전체 일관성을 검증해야 함

---

## 📁 이벤트 기반 요구사항 (EVENT-DRIVEN)

### WHEN 원고가 처리 대기열에 들어올 때

```
GIVEN: SPEC-001~006 중 하나의 파이프라인에서 처리 요청
WHEN: 원고 파일 + 메타데이터 수신
THEN: 시스템은 다음을 수행해야 함
  ✅ 원고 기본 정보 기록:
       - 원본 파일명
       - 대상 SPEC (SPEC-001, 002, ... 006)
       - 메타데이터 (제목, 저자, 언어 등)
       - 타임스탐프
  ✅ 원고 상태 초기화 (상태: RECEIVED)
  ✅ 처리 큐에 등록
```

### WHEN 청킹 단계가 시작될 때

```
GIVEN: 처리 대기 중인 원고
WHEN: 오케스트레이터가 청킹 시작 결정
THEN: 시스템은 다음을 수행해야 함
  ✅ [moai-pub-chunking] 스킬 호출:
       - 원고 크기 분석
       - 청킹 규칙 결정 (기본: 50KB 기준)
       - 청크 생성 (메타데이터 첨부):
         * 청크ID (CHUNK-001, CHUNK-002, ...)
         * 원본 위치 정보 (시작 단락, 끝 단락)
         * 문맥 겹침 정보 (앞 청크 마지막 N줄, 뒤 청크 첫 N줄)
         * 처리 순서 (우선순위 정보)
  ✅ 청킹 메타데이터 저장 (DB/파일)
  ✅ 상태 업데이트 (상태: CHUNKED)
```

### WHEN 병렬 처리를 조율할 때

```
GIVEN: 청킹 완료된 원고 (N개 청크)
WHEN: 병렬 처리 단계
THEN: 시스템은 다음을 수행해야 함
  ✅ 사용 가능한 에이전트 풀 확인
  ✅ 병렬도 결정 (최대 5개, 리소스 상황 고려)
  ✅ 각 청크를 에이전트에 할당:
       - 작업 타입 (번역, 편집, 집필 등)
       - 청크 컨텍스트 (앞/뒤 청크 요약)
       - 처리 지침 (스타일 가이드 등)
  ✅ 작업 실행 시작
  ✅ 실시간 진행 상황 모니터링:
       - 각 청크별 상태 추적
       - 예상 완료 시간 계산
       - 병목 지점 감지
  ✅ 상태 업데이트 (상태: PROCESSING)
```

### WHEN 청크별 처리가 완료될 때

```
GIVEN: 에이전트에서 처리 완료된 청크
WHEN: 결과 수신
THEN: 시스템은 다음을 수행해야 함
  ✅ 일차 품질 검수:
       - 형식 검증 (마크다운 유효성)
       - 길이 검증 (극단적인 감축/팽창 확인)
       - 메타데이터 검증 (청크ID, 위치 정보 정합성)
  ✅ 검수 결과 기록:
       - PASS: 다음 단계로
       - FAIL: 재처리 필요 (큐에 재등록)
       - REVIEW: 사용자 검토 필요
  ✅ 처리 결과 임시 저장
  ✅ 상태 업데이트 (상태: CHUNK_COMPLETE)
```

### WHEN 모든 청크 처리가 완료될 때

```
GIVEN: 모든 청크 처리 완료
WHEN: 최종 청크 수신
THEN: 시스템은 다음을 수행해야 함
  ✅ 통합 준비:
       - 모든 청크 처리 상태 확인
       - 실패 또는 대기 중인 청크 확인
       - 필요시 사용자 개입 요청
  ✅ 상태 업데이트 (상태: READY_FOR_MERGE)
```

### WHEN 청크 통합 단계가 시작될 때

```
GIVEN: 모든 청크 처리 완료 + 사용자 승인
WHEN: 오케스트레이터가 통합 시작
THEN: 시스템은 다음을 수행해야 함
  ✅ 청크 재결합:
       - 메타데이터의 원본 위치 정보로 순서 복원
       - 청크 간 문맥 겹침 제거
       - 불일치 지점 자동 감지 및 수정
  ✅ 장절 제목/번호 복원
  ✅ 목차 자동 생성
  ✅ 상호 참조 검증 (예: "앞의 3장에서...")
  ✅ 임시 통합 파일 생성
  ✅ 상태 업데이트 (상태: MERGED)
```

### WHEN 최종 일관성 검수가 진행될 때

```
GIVEN: 통합된 전체 원고
WHEN: 최종 검수 단계
THEN: 시스템은 다음을 수행해야 함
  ✅ 다층 검수 수행:
       1. 구조적 검수:
          - 장절 순서 정확성
          - 목차 정확성
          - 상호 참조 정합성
       2. 용어 통일 검수:
          - 전체 원고에서 일관성 ≥95%
          - 불일치 항목 자동 수정 또는 플래그
       3. 톤앤매너 일관성 검수:
          - 챕터 간 문체 차이 감지
          - 불일치 부분 플래그
       4. 논리적 연속성 검수:
          - 단락 간 논리적 흐름
          - 이상 신호 감지
  ✅ 검수 결과 리포트 생성
  ✅ 상태 업데이트 (상태: REVIEWED)
```

### WHEN 최종 마크다운 생성이 진행될 때

```
GIVEN: 검수 완료된 통합 원고
WHEN: 최종 마크다운 생성
THEN: 시스템은 다음을 수행해야 함
  ✅ 최종 마크다운 파일 생성:
       - 올바른 마크다운 형식
       - 메타데이터 헤더 포함
       - 목차 포함
       - 모든 포맷 요소 포함 (강조, 리스트, 코드 등)
  ✅ 최종 검증:
       - 파일 형식 검증
       - 길이 검증 (예상치 ±10% 범위)
       - 메타데이터 완결성 검증
  ✅ 최종 파일 저장
  ✅ 상태 업데이트 (상태: COMPLETED)
```

---

## 🚫 원하지 않는 동작 (UNWANTED BEHAVIOR)

### IF 청킹 과정에서 문맥 손실 발생

```
THEN: 시스템은 다음을 수행해야 함
  ✅ 문맥 겹침 자동 추가
  ✅ 손실 부분 복구 시도
  ✅ 완전히 복구 불가능 시 플래그 표시 + 사용자 경고
```

### IF 청크 통합 시 불일치 지점 발견

```
THEN: 시스템은 다음을 수행해야 함
  ✅ 불일치 부분 명확히 식별
  ✅ 자동 수정 시도 (문맥 기반)
  ✅ 자동 수정 불가능 시 사용자 검토 요청
```

### IF 병렬 처리 중 작업 실패

```
THEN: 시스템은 다음을 수행해야 함
  ✅ 실패한 청크 즉시 식별
  ✅ 오류 원인 기록
  ✅ 실패한 청크만 재처리 큐에 추가
  ✅ 다른 청크는 계속 진행
```

### IF 일관성 검수에서 광범위한 불일치 발견

```
THEN: 시스템은 다음을 수행해야 함
  ✅ 심각도 평가
  ✅ 자동 수정 가능 부분 처리
  ✅ 사용자 검토 필요 부분 플래그 표시
  ✅ 심각도 높은 항목은 진행 중단 제안
```

---

## ⚙️ 상태 기반 요구사항 (STATE-DRIVEN)

### WHILE 병렬 처리 진행 중

```
시스템은 다음을 유지해야 함:
  ✅ 전체 처리 상태 머신:
       RECEIVED → CHUNKED → PROCESSING →
       CHUNK_COMPLETE → READY_FOR_MERGE → MERGED →
       REVIEWED → COMPLETED
  ✅ 각 청크별 개별 상태 추적
  ✅ 실시간 진행률 계산
  ✅ 병목 지점 자동 감지
  ✅ 예상 완료 시간 동적 업데이트
  ✅ 리소스 사용률 모니터링
```

---

## 🎁 선택 기능 (OPTIONAL)

### WHERE 사용자가 청킹 규칙을 커스터마이징하고 싶을 때

```
시스템은 다음을 제공해야 함:
  ✅ 청크 크기 조정 (기본 50KB에서 변경)
  ✅ 문맥 겹침 정도 조정
  ✅ 청킹 기준 선택 (단어 수, 단락 수, 의미 단위)
```

### WHERE 사용자가 병렬도를 조정하고 싶을 때

```
시스템은 다음을 제공해야 함:
  ✅ 병렬도 선택 (1-10)
  ✅ 리소스 제약 반영
  ✅ 예상 완료 시간 계산
```

### WHERE 사용자가 검수 강도를 조정하고 싶을 때

```
시스템은 다음을 제공해야 함:
  ✅ 검수 강도 선택 (기본/강화/최대)
  ✅ 강도별 검수 항목 명시
  ✅ 예상 검수 시간 제시
```

---

## ✅ 수용 기준 (ACCEPTANCE CRITERIA)

### Given/When/Then 시나리오 1: 전체 파이프라인 흐름

```
Given: 100,000단어 원고 (SPEC-001 번역 작업)
When: 전체 오케스트레이션 파이프라인 실행
Then:
  ✅ 청킹: 30분 내 완료 (2개 청크)
  ✅ 병렬 처리: 각 청크 3-5시간 (병렬로 동시 진행)
  ✅ 청크별 품질 검수: 각 청크 ≥85점
  ✅ 통합: 1시간 내 완료
  ✅ 최종 검수: 2-3시간
  ✅ 총 소요 시간: 3-5시간 (병렬 효과)
  ✅ 최종 일관성: ≥95점
  ✅ 메타데이터 정확성: 100%
```

### Given/When/Then 시나리오 2: 청크 단위 재처리

```
Given: 통합 완료된 원고 중 1개 청크 재처리 필요
When: 해당 청크만 재처리 요청
Then:
  ✅ 영향받은 청크만 재처리 (30분-1시간)
  ✅ 나머지 청크 영향 없음
  ✅ 재통합 (30분)
  ✅ 전체 일관성 재검수 (1-2시간)
  ✅ 최종 원고 재생성
```

### Given/When/Then 시나리오 3: 병렬도 최적화

```
Given: 100,000단어, 병렬도 5 설정
When: 병렬 처리 실행
Then:
  ✅ 5개 청크 동시 처리
  ✅ 예상 완료 시간: 순차 대비 70% 단축
  ✅ 각 청크 독립적 처리 (의존성 없음)
  ✅ 완료 시간: 앞쪽 청크와 뒤쪽 청크 시간 차 ≤30분
  ✅ 통합 시 모든 청크 준비 완료
```

### Given/When/Then 시나리오 4: 일관성 검수 효율성

```
Given: 2개 청크 병렬 처리 완료 + 통합
When: 최종 일관성 검수 실행
Then:
  ✅ 청크 간 용어 불일치: 자동 감지 100%
  ✅ 톤앤매너 불일치: 자동 감지 ≥90%
  ✅ 논리적 연속성 오류: 자동 감지 ≥85%
  ✅ 최종 일관성 점수: ≥95점
```

---

## 📊 기술 스택 및 의존성

**핵심 컴포넌트**:
- 상태 관리 시스템 (State Machine)
- 메타데이터 추적 시스템 (DB 또는 파일)
- 작업 큐 시스템 (병렬 처리 조율)
- 진행 모니터링 시스템 (실시간 추적)

**필수 스킬**:
- `moai-pub-chunking`: 청크 생성 및 관리
- `moai-pub-orchestrator`: 병렬 처리 조율
- `moai-pub-style-guide`: 일관성 검수 규칙

**외부 의존성**:
- 모든 SPEC-001~006의 에이전트 + 스킬

**버전 요구사항**:
- Python ≥3.11
- Claude Sonnet 4.5+ (일관성 검수)
- Claude Haiku 4.5 (병렬 처리)

---

## 📈 성공 지표

- **청킹 속도**: 100K 단어 30분 내 완료
- **병렬 처리 효율**: 순차 대비 60-70% 시간 단축
- **청크 품질**: 각 청크 ≥85점
- **통합 정확성**: 100% (메타데이터 기반)
- **일관성**: ≥95점
- **시스템 안정성**: 99.5% 성공률

---

## 🔄 의존성

- SPEC-001~006: 모든 주요 SPEC의 기반
- `moai-pub-chunking` 스킬: 핵심 의존성
- 모든 관련 에이전트: 병렬 처리 필요
